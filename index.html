<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Конвертер валют</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:Segoe UI,system-ui,sans-serif;
    background:linear-gradient(145deg,#1e2b5e,#4a3f6e);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
}
.converter{
    width:100%;
    max-width:750px;
    background:rgba(255,255,255,0.1);
    backdrop-filter:blur(15px);
    border-radius:40px;
    padding:40px;
    color:#fff;
    position:relative;
}
h1{font-size:2.4rem;margin-bottom:10px}
.sub{opacity:.8;margin-bottom:25px}
.input-field{margin-bottom:20px}
label{display:block;font-size:.8rem;margin-bottom:6px;opacity:.8;text-transform:uppercase}
input{
    width:100%;
    padding:14px 18px;
    border-radius:30px;
    border:none;
    background:rgba(255,255,255,0.2);
    color:#fff;
    font-size:1rem;
}
.row{display:flex;gap:15px;align-items:flex-end;margin-bottom:20px}
.row .input-field{flex:1;margin-bottom:0}
button{
    padding:14px;
    border:none;
    border-radius:30px;
    background:linear-gradient(45deg,#8a76f0,#b09cff);
    color:#fff;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 4px 15px rgba(123,104,238,0.5);
    transition:all 0.2s;
}
button:hover{
    background:linear-gradient(45deg,#9f8bff,#c3b2ff);
    box-shadow:0 6px 20px rgba(123,104,238,0.8);
    transform:scale(1.02);
}
.swap{
    width:50px;height:50px;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    background:rgba(255,255,255,0.3);
    border:1px solid rgba(255,255,255,0.6);
    box-shadow:none;
}
.swap:hover{
    background:rgba(255,255,255,0.5);
    transform:scale(1.05);
}
.result{
    margin-top:25px;
    padding:20px;
    border-radius:25px;
    background:rgba(255,255,255,0.15);
    text-align:center;
    font-size:1.2rem;
    white-space:pre-line;
}
.error{
    margin-top:15px;
    padding:12px;
    background:rgba(255,80,80,0.4);
    border-radius:20px;
    text-align:center;
}
.hidden{display:none}
.select{
    position:relative;
}
.selected{
    padding:14px 18px;
    background:rgba(255,255,255,0.2);
    border-radius:30px;
    cursor:pointer;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
.dropdown{
    position:absolute;
    top:100%;
    left:0;
    right:0;
    margin-top:8px;
    background:#2a2f4b;
    border-radius:20px;
    max-height:300px;
    overflow-y:auto;
    display:none;
    z-index:20;
}
.search{
    padding:10px;
    border-bottom:1px solid rgba(255,255,255,0.1);
    position:sticky;
    top:0;
    background:#2a2f4b;
    border-radius:20px 20px 0 0;
}
.search input{
    width:100%;
    border-radius:15px;
    padding:8px;
    background:#1f233a;
    border:none;
    color:#fff;
}
.option{
    padding:10px 15px;
    cursor:pointer;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
.option:hover{background:#7b68ee}
.loader {
    position:absolute;
    top:20px;
    right:20px;
    width:24px;
    height:24px;
    border:3px solid rgba(255,255,255,0.3);
    border-radius:50%;
    border-top-color:#fff;
    animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="converter">
<h1>Конвертер валют</h1>
<div class="sub">Автообновление каждые 60 секунд</div>
<form id="form">
<div class="input-field">
<label>Сумма</label>
<input type="number" id="amount" value="1" min="0" step="any">
</div>
<div class="row">
<div class="input-field">
<label>Из</label>
<div id="from" class="select"></div>
</div>
<button type="button" id="swap" class="swap">
<i class="fas fa-exchange-alt"></i>
</button>
<div class="input-field">
<label>В</label>
<div id="to" class="select"></div>
</div>
</div>
<button>Конвертировать</button>
</form>
<div id="result" class="result hidden"></div>
<div id="error" class="error hidden"></div>
<div id="loader" class="loader hidden"></div>
</div>
<script>
const API_URL = "https://api.exchangerate-api.com/v4/latest/USD";
const FALLBACK_CURRENCIES = ["USD", "EUR", "GBP", "JPY", "CHF", "CAD", "AUD", "CNY", "RUB", "INR", "BRL", "ZAR", "TRY", "KRW", "SGD", "NZD", "MXN", "HKD", "NOK", "SEK", "DKK", "PLN", "CZK", "HUF", "ILS", "AED", "SAR", "THB", "MYR", "IDR", "PHP", "KWD", "QAR", "UAH"];

const form = document.getElementById("form");
const amountInput = document.getElementById("amount");
const swapBtn = document.getElementById("swap");
const resultBox = document.getElementById("result");
const errorBox = document.getElementById("error");
const loader = document.getElementById("loader");
const fromContainer = document.getElementById("from");
const toContainer = document.getElementById("to");

let fromSelect, toSelect;
let cache = {};
let pendingRequest = false;
let debounceTimer;
const CACHE_TTL = 300000;

let currencyNameFormatter = null;
try {
    if (typeof Intl !== 'undefined' && Intl.DisplayNames) {
        currencyNameFormatter = new Intl.DisplayNames('ru', { type: 'currency' });
    }
} catch (e) {}

function getCurrencyName(code) {
    if (!currencyNameFormatter) return null;
    try {
        const name = currencyNameFormatter.of(code);
        return name && name !== code ? name : null;
    } catch {
        return null;
    }
}

function showError(t) { 
    errorBox.textContent = t; 
    errorBox.classList.remove("hidden"); 
}
function hideError() { errorBox.classList.add("hidden"); }
function showResult(t) { 
    resultBox.textContent = t; 
    resultBox.classList.remove("hidden"); 
}
function hideResult() { resultBox.classList.add("hidden"); }
function format(n) { 
    return new Intl.NumberFormat("ru-RU", { maximumFractionDigits: 2 }).format(n); 
}
function setLoading(isLoading) {
    if (isLoading) loader.classList.remove("hidden");
    else loader.classList.add("hidden");
}

class Select {
    constructor(container, options) {
        this.container = container;
        this.options = options;
        this.value = options[0] || "";
        this.render();
    }
    render() {
        this.container.innerHTML = "";
        const selected = document.createElement("div");
        selected.className = "selected";
        selected.textContent = this.value || "—";
        const name = getCurrencyName(this.value);
        if (name) selected.title = name;
        this.container.appendChild(selected);
        
        const dropdown = document.createElement("div");
        dropdown.className = "dropdown";
        
        const searchDiv = document.createElement("div");
        searchDiv.className = "search";
        const searchInput = document.createElement("input");
        searchInput.placeholder = "Поиск по коду или названию...";
        searchDiv.appendChild(searchInput);
        dropdown.appendChild(searchDiv);
        
        const list = document.createElement("div");
        dropdown.appendChild(list);
        
        const renderOptions = (filter = "") => {
            list.innerHTML = "";
            const lowerFilter = filter.toLowerCase();
            this.options
                .filter(code => {
                    const name = getCurrencyName(code) || "";
                    return code.toLowerCase().includes(lowerFilter) || name.toLowerCase().includes(lowerFilter);
                })
                .forEach(code => {
                    const opt = document.createElement("div");
                    opt.className = "option";
                    const name = getCurrencyName(code);
                    opt.textContent = name ? `${code} – ${name}` : code;
                    opt.setAttribute('data-code', code);
                    opt.onclick = () => {
                        this.value = code;
                        selected.textContent = code;
                        const newName = getCurrencyName(code);
                        if (newName) selected.title = newName;
                        else selected.removeAttribute('title');
                        dropdown.style.display = "none";
                        convert();
                    };
                    list.appendChild(opt);
                });
        };
        renderOptions();
        
        searchInput.oninput = () => renderOptions(searchInput.value);
        
        selected.onclick = () => {
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
            if (dropdown.style.display === "block") {
                searchInput.focus();
                renderOptions(searchInput.value);
            }
        };
        
        document.addEventListener("click", (e) => {
            if (!this.container.contains(e.target)) dropdown.style.display = "none";
        });
        
        this.container.appendChild(dropdown);
    }
    get() { return this.value; }
    set(v) {
        this.value = v;
        const selectedDiv = this.container.querySelector(".selected");
        if (selectedDiv) {
            selectedDiv.textContent = v;
            const name = getCurrencyName(v);
            if (name) selectedDiv.title = name;
            else selectedDiv.removeAttribute('title');
        }
    }
}

async function loadCurrencies() {
    setLoading(true);
    try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        const codes = Object.keys(data.rates).sort();
        
        fromSelect = new Select(fromContainer, codes);
        toSelect = new Select(toContainer, codes);
        fromSelect.set("USD");
        toSelect.set("EUR");
        hideError();
        convert();
    } catch (error) {
        console.warn('Using fallback currencies:', error);
        fromSelect = new Select(fromContainer, FALLBACK_CURRENCIES);
        toSelect = new Select(toContainer, FALLBACK_CURRENCIES);
        fromSelect.set("USD");
        toSelect.set("EUR");
        hideError();
        convert();
    } finally {
        setLoading(false);
    }
}

async function getRates(base) {
    const now = Date.now();
    if (cache[base] && now - cache[base].timestamp < CACHE_TTL) {
        return cache[base].rates;
    }
    setLoading(true);
    try {
        const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${base}`);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        cache[base] = {
            rates: data.rates,
            timestamp: now
        };
        return data.rates;
    } finally {
        setLoading(false);
    }
}

async function convert() {
    if (!fromSelect || !toSelect) return;
    if (pendingRequest) return;
    
    const amount = parseFloat(amountInput.value);
    if (!amount || amount <= 0) {
        showError("Введите положительное число");
        hideResult();
        return;
    }
    
    const from = fromSelect.get();
    const to = toSelect.get();
    if (!from || !to) {
        showError("Не выбрана валюта");
        return;
    }
    
    hideError();
    pendingRequest = true;
    
    try {
        const rates = await getRates(from);
        const result = amount * rates[to];
        const fromName = getCurrencyName(from);
        const toName = getCurrencyName(to);
        const fromDisplay = fromName ? `${from} (${fromName})` : from;
        const toDisplay = toName ? `${to} (${toName})` : to;
        showResult(`${format(amount)} ${fromDisplay} = ${format(result)} ${toDisplay}`);
    } catch (error) {
        showError("Ошибка конвертации. Попробуйте позже.");
        console.error(error);
        hideResult();
    } finally {
        pendingRequest = false;
    }
}

function debouncedConvert() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => convert(), 500);
}

form.onsubmit = (e) => { 
    e.preventDefault(); 
    clearTimeout(debounceTimer);
    convert(); 
};

swapBtn.onclick = () => {
    if (!fromSelect || !toSelect) return;
    const f = fromSelect.get();
    const t = toSelect.get();
    fromSelect.set(t);
    toSelect.set(f);
    clearTimeout(debounceTimer);
    convert();
};

amountInput.oninput = debouncedConvert;

setInterval(() => {
    if (!document.hidden) convert();
}, 60000);

loadCurrencies();
</script>
</body>
</html>

